# Build Instructions

This document explains how to build the Kokoro TTS Firefox extension from source.

## Prerequisites

- **Node.js** (v14 or higher) and **npm** (v6 or higher)
- **Git** (for cloning the repository)
- **zip** utility (usually pre-installed on Linux/macOS, available on Windows)

## Quick Build

```bash
# Clone the repository
git clone https://github.com/groxaxo/kokoro-tts-addon.git
cd kokoro-tts-addon

# Install dependencies (only needed once or after updates)
npm install

# Build the extension
./build-xpi.sh  # Linux/macOS
# or
build-xpi.bat   # Windows
```

This will create `kokoro-tts-addon-v3.1.xpi` in the current directory.

## Build Process Explained

The build process consists of two main steps:

### Step 1: Bundle JavaScript with Rollup

```bash
npm run build
```

This command:
- Reads `src/content.js` (the source content script)
- Bundles it with the `kokoro-js` library and all its dependencies
- Creates `dist/content-bundle.js` (~3.5MB uncompressed)

The bundling is necessary because Firefox extensions cannot dynamically import external modules due to Content Security Policy (CSP) restrictions.

### Step 2: Package Extension Files

```bash
./build-xpi.sh  # or build-xpi.bat
```

This command:
- Runs `npm run build` to create the bundle
- Creates a ZIP archive with the `.xpi` extension
- Includes: manifest.json, background.js, bundled content script, popup files, player files, styles, and icons
- Generates a SHA256 checksum file

## What Gets Bundled?

The Rollup bundler includes:
- Your content script code (`src/content.js`)
- `kokoro-js` library (v1.2.1)
- `@huggingface/transformers` library
- `onnxruntime-web` and related dependencies
- All necessary dependencies for browser-based TTS

## File Structure

```
kokoro-tts-addon/
├── src/
│   └── content.js          # Source content script (with static imports)
├── dist/
│   └── content-bundle.js   # Bundled content script (generated by Rollup)
├── manifest.json           # Extension manifest (references dist/content-bundle.js)
├── background.js           # Background script (not bundled)
├── popup.html/js           # Extension popup UI
├── player.html/js          # Audio player
├── package.json            # npm configuration
├── rollup.config.js        # Rollup bundler configuration
└── build-xpi.sh/bat        # Build scripts
```

## Troubleshooting

### "npm: command not found"
Install Node.js and npm from https://nodejs.org/

### "rollup: command not found"
Run `npm install` to install dependencies.

### Build fails with module errors
- Delete `node_modules/` directory
- Delete `package-lock.json`
- Run `npm install` again

### XPI is too large
This is normal. The bundled content script includes the entire kokoro-js library (~3.5MB uncompressed, ~1MB in the XPI). This allows the extension to work without external CDN dependencies.

## Development Workflow

1. Make changes to `src/content.js` or other source files
2. Run `npm run build` to rebuild the bundle
3. Test the extension by loading it in Firefox (`about:debugging`)
4. When ready, run `./build-xpi.sh` to create the final XPI

## Clean Build

To start fresh:

```bash
# Remove build artifacts
rm -rf dist/ node_modules/ package-lock.json *.xpi *.xpi.sha256

# Reinstall dependencies
npm install

# Build
./build-xpi.sh
```

## Why Bundling?

The original implementation used dynamic imports:
```javascript
const module = await import('https://cdn.jsdelivr.net/npm/kokoro-js@0.2.1/+esm');
```

This approach fails in Firefox extensions due to CSP restrictions. The bundling solution:
- ✅ Works in Firefox extensions
- ✅ No external CDN dependencies
- ✅ Faster loading (no network requests)
- ✅ Works offline immediately
- ❌ Larger file size (but still reasonable at ~1MB)

## Additional Notes

- The `content.js` file in the root directory is the original file (kept for reference)
- The actual source is now in `src/content.js`
- The `dist/` directory is generated and should not be committed to git
- The `node_modules/` directory contains npm dependencies and should not be committed
